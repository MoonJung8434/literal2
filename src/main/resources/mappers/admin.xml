<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.literal.admin.adminMapper">

	<!-- 회원 목록 조회 쿼리 -->
    <select id="getAllMembers" resultType="kr.co.literal.member.MemberDTO">
        SELECT * FROM member
    </select>
	
	<!-- 상품 목록 조회 -->
 	<select id="list" resultType="java.util.Map">
		SELECT  book_number, book_title, original_price, sale_price, img, img_size, registration_date
        FROM product
        ORDER BY registration_date DESC
	</select>
	
	<!-- 상품 상세 -->
	<select id="detail" resultType="java.util.Map" parameterType="String">
        SELECT book_number, genre_code, book_code, book_title, author, book_detail, img, img_size, grade_code, original_price, sale_price, registration_date, email, availability, branch_code
        FROM product
        WHERE book_number = #{book_number}
    </select>
	
	<!-- 이미지 -->
    <select id="img" resultType="String" parameterType="String">
        SELECT img
        FROM product
        WHERE book_number=#{book_number}
    </select>
    
        <!-- 장르 코드로 새로운 책 코드 생성 -->
    <select id="genreBookCode" resultType="int">
        SELECT COALESCE(MAX(CAST(SUBSTRING_INDEX(book_code, '-', -1) AS UNSIGNED)), 0) + 1
        FROM product
        WHERE genre_code = #{genre_code}
    </select>

    <!-- 주어진 장르 코드와 책 코드로 다음 책 번호 가져오기 -->
    <select id="getNextBookNumber" resultType="int">
        SELECT COALESCE(MAX(CAST(RIGHT(book_number, 3) AS UNSIGNED)), 0) + 1
        FROM product
        WHERE genre_code = #{genre_code} AND book_code = #{book_code}
    </select>

    <!-- 주어진 책 코드가 존재하는지 확인 -->
    <select id="bookCodeExists" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM product WHERE book_code = #{book_code}
    </select>

    <!-- 주어진 책 번호가 존재하는지 확인 -->
    <select id="bookNumberExists" parameterType="string" resultType="int">
	    SELECT COUNT(*) FROM product 
	    WHERE genre_code = #{genreCode} AND book_number = #{bookNumber}
    </select>

    <!-- 주어진 책 제목이 존재하는지 확인 -->
    <select id="bookTitleExists" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM product 
        WHERE genre_code = #{genre_code} AND book_title = #{book_title}
    </select>

    <!-- 주어진 책 제목으로 책 코드 가져오기 -->
    <select id="getBookCodeByTitle" parameterType="string" resultType="string">
        SELECT book_code FROM product 
        WHERE genre_code = #{genre_code} AND book_title = #{book_title}
    </select>


	<!-- 상품 수정 -->
	<update id="update" parameterType="java.util.Map">
        UPDATE product
        SET genre_code = #{genre_code},
            book_code = #{book_code},
        	book_number = #{book_number},
        	book_title=#{book_title},
        	author=#{author},
        	grade_code=#{grade_code},
        	original_price=#{original_price},
            sale_price=#{sale_price},
            book_detail=#{book_detail},
            img=#{img},
            img_size=#{img_size},
            branch_code = #{branch_code}           
        WHERE book_number=#{original_book_number}
    </update>
   
   
	<!-- 상품 조회 -->
	<select id="search" resultType="java.util.Map" parameterType="String">
		SELECT book_number, book_title, original_price, sale_price, img, img_size
        FROM product
        WHERE book_title LIKE #{keyword}
        ORDER BY book_title
	</select>
</mapper>